<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>校园后勤管理系统</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Microsoft YaHei", Arial, sans-serif;
        background-image: url(http://localhost:8081/img/35e1b763c15645c1a6d674accf959f30.jpg);
        min-height: 100vh;
        background-size: cover;
        background-attachment: fixed;
      }

      /* 顶部导航栏 */
      .header {
        background: #3f51b5;
        color: white;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .header h1 {
        padding-left: 20px;
        font-size: 24px;
        font-weight: normal;
      }

      .user-icon {
        width: 45px;
        height: 45px;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid rgba(255, 255, 255, 0.5);
        overflow: hidden;
      }

      .user-icon:hover {
        transform: scale(1.05);
        border-color: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      }

      /* 下拉菜单容器 */
      .dropdown-container {
        position: relative;
        display: inline-block;
      }

      /* 下拉菜单 */
      .dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 10px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        z-index: 1000;
        width: 150px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
      }

      /* 悬停显示下拉菜单 */
      .dropdown-container:hover .dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      /* 下拉菜单项 */
      .dropdown-item {
        width: 100%;
        padding: 12px 20px;
        background: none;
        border: none;
        text-align: left;
        cursor: pointer;
        color: #333;
        font-size: 14px;
        transition: all 0.2s;
        outline: none;
      }

      /* 下拉菜单项悬停效果 */
      .dropdown-item:hover {
        background: #f5f5f5;
        color: #3f51b5;
      }

      /* 下拉菜单项分隔线 */
      .dropdown-item:not(:last-child) {
        border-bottom: 1px solid #eee;
      }

      /* 主容器 */
      .container {
        display: flex;
        min-height: calc(100vh - 70px);
      }

      /* 左侧边栏 */
      .user-main-icon {
        margin: 20% auto 20px;
        width: 110px;
        height: 110px;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.5);
        overflow: hidden;
      }
      .sidebar {
        width: 230px;
        background: rgba(232, 234, 246, 0.95);
        padding: 30px 0;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }

      .sidebar-profile {
        text-align: center;
        padding: 0 20px 30px;
        border-bottom: 1px solid #c5cae9;
      }

      .sidebar-avatar {
        width: 80px;
        height: 80px;
        background: #5c6bc0;
        border-radius: 50%;
        margin: 0 auto 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background-size: cover;
        background-position: center;
      }

      .sidebar-avatar svg {
        width: 40px;
        height: 40px;
        fill: white;
      }

      .sidebar-name {
        font-size: 16px;
        color: #333;
        font-weight: 500;
      }

      .sidebar-menu {
        padding: 20px 0;
      }

      .menu-item {
        padding: 15px 25px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: all 0.3s;
        color: #555;
        text-decoration: none;
        border-left: 3px solid transparent;
      }

      .menu-item:hover {
        background: rgba(63, 81, 181, 0.1);
        color: #3f51b5;
      }

      .menu-item.active {
        background: rgba(63, 81, 181, 0.15);
        color: #3f51b5;
        border-left-color: #3f51b5;
        font-weight: 500;
      }

      .menu-item-left {
        display: flex;
        align-items: center;
      }

      .menu-item-left {
        position: relative;
        padding-left: 14px;
      }

      .menu-item.active .menu-item-left::before {
        content: ">";
        position: absolute;
        left: 0;
        color: currentColor;
        font-weight: 700;
      }

      .menu-item.active .menu-item-left::after {
        content: "<";
        position: absolute;
        right: 0px;
        transform: translateX(15px);
        color: currentColor;
        font-weight: 700;
      }

      .menu-icon {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        fill: currentColor;
      }

      .menu-arrow {
        font-size: 14px;
        color: #999;
      }

      /* 主内容区域 */
      .main-content {
        flex: 1;
        padding: 30px 40px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }
      .main-content .gcc-logo {
        right: 5%;
        bottom: 10%;
        width: 100px;
        height: auto;
        position: absolute;
      }

      .content-card {
        background: rgb(255, 255, 255);
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 30px;
        height: 100%;
        max-width: 100%;
        min-height: unset; /* 移除最小高度限制 */
      }

      .sidebar-view {
        height: 100%;
      }

      .card-title {
        font-size: 24px;
        color: #333;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f2f5;
      }

      /* 标签页 */
      .tabs {
        display: flex;
        gap: 30px;
        margin-bottom: 30px;
        border-bottom: 2px solid #f0f2f5;
      }

      .tab {
        padding: 12px 5px;
        background: none;
        border: none;
        color: #666;
        font-size: 15px;
        cursor: pointer;
        position: relative;
        transition: all 0.3s;
      }

      .tab:hover {
        color: #3f51b5;
      }

      .tab.active {
        color: #3f51b5;
        font-weight: 500;
      }

      .tab.active::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background: #3f51b5;
      }

      /* 信息表单 */
      .info-form {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 20px;
      }

      .form-row {
        position: relative;
        display: flex;
      }

      .form-row::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        width: 0;
        background: #3f51b5;
        transition: width 0.2s ease;
      }

      .form-row:hover::after {
        width: 100%;
      }

      .form-label {
        font-weight: bold;
        width: 100px;
        color: #333;
        font-size: 16px;
      }

      .form-value {
        flex: 1;
        color: #333;
        font-size: 16px;
      }

      .editable-field {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .edit-button {
        background: none;
        border: none;
        color: #3f51b5;
        font-size: 13px;
        cursor: pointer;
        padding: 4px 8px;
        transition: all 0.3s;
      }

      .edit-button:hover {
        text-decoration: underline;
      }

      .back-button {
        background: none;
        border: none;
        color: white;
        font-size: 28px;
        cursor: pointer;
        padding: 5px 15px;
        transition: opacity 0.3s;
      }

      .back-button:hover {
        opacity: 0.8;
      }

      .header-left {
        display: flex;
        align-items: center;
      }

      /* 编辑模态框 */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal.show {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 8px;
        padding: 30px;
        width: 90%;
        max-width: 450px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        font-size: 18px;
        color: #333;
        margin-bottom: 20px;
        font-weight: 500;
      }

      .modal-body {
        margin-bottom: 25px;
      }

      .modal-input {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: all 0.3s;
      }

      .modal-input:focus {
        outline: none;
        border-color: #3f51b5;
        box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.1);
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .modal-button {
        padding: 8px 20px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .modal-button.primary {
        background: #3f51b5;
        color: white;
      }

      .modal-button.primary:hover {
        background: #303f9f;
      }

      .modal-button.secondary {
        background: #f0f2f5;
        color: #666;
      }

      .modal-button.secondary:hover {
        background: #e0e0e0;
      }

      /* 头像上传样式 */
      .avatar-upload-container {
        display: flex;
        flex-direction: column;
        gap: 30px;
        max-width: 500px;
      }

      .avatar-preview-box {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
      }

      .avatar-preview {
        width: 200px;
        height: 200px;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        border-radius: 8px;
        border: 2px dashed #ddd;
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .avatar-preview:hover {
        border-color: #3f51b5;
        box-shadow: 0 0 10px rgba(63, 81, 181, 0.1);
      }

      .avatar-preview.has-image .avatar-placeholder {
        display: none;
      }

      .avatar-placeholder {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #f5f5f5;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #999;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .avatar-plus-icon {
        font-size: 48px;
        font-weight: 300;
        margin-bottom: 10px;
        color: #ccc;
      }

      .avatar-placeholder-text {
        font-size: 14px;
        color: #999;
      }

      .avatar-upload-label {
        padding: 10px 20px;
        background: #3f51b5;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
        display: inline-block;
      }

      .avatar-upload-label:hover {
        background: #303f9f;
      }

      .avatar-upload-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }

      .avatar-info-text {
        font-size: 14px;
        color: #666;
        margin: 0;
        text-align: center;
      }

      .avatar-upload-button {
        padding: 12px 40px;
        background: #3f51b5;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .avatar-upload-button:hover {
        background: #303f9f;
        box-shadow: 0 2px 8px rgba(63, 81, 181, 0.3);
      }

      .avatar-upload-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        box-shadow: none;
      }

      .upload-status {
        font-size: 14px;
        min-height: 20px;
        text-align: center;
      }

      .upload-status.success {
        color: #4caf50;
      }

      .upload-status.error {
        color: #f44336;
      }

      .upload-status.loading {
        color: #3f51b5;
      }

      /* 密码修改表单样式 */
      .password-change-form {
        max-width: 350px;
        margin: 0 auto;
        margin-left: 20px;
      }

      .form-group {
        margin-left: 20px;
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        font-weight: bold;
        color: #333;
        margin-bottom: 8px;
        font-size: 16px;
      }

      .input-wrapper {
        position: relative;
      }

      .form-input {
        width: 100%;
        height: 30px;
        padding: 12px 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: white;
      }

      .form-input:focus {
        outline: none;
        border-color: #3f51b5;
        box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.1);
      }

      .form-input:invalid {
        border-color: #9b9b9b;
      }

      .error-message {
        color: #f44336;
        font-size: 14px;
        margin-top: 4px;
        min-height: 20px;
      }

      /* 验证码样式 */
      .verify-code-group {
        display: flex;
        gap: 15px;
        align-items: flex-start;
      }

      .verify-code-left {
        width: 150px;
        flex: 1;
      }

      .verify-code-right {
        margin-top: 28px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .verify-code-img {
        width: 120px;
        height: 44px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .verify-code-img:hover {
        border-color: #3f51b5;
      }

      .refresh-verify-code {
        color: #3f51b5;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .refresh-verify-code:hover {
        text-decoration: underline;
      }

      /* 表单操作按钮 */
      .form-actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        margin-left: 20px;
      }

      .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .btn-primary {
        background: #3f51b5;
        color: white;
      }

      .btn-primary:hover {
        background: #303f9f;
        box-shadow: 0 2px 8px rgba(63, 81, 181, 0.3);
      }

      .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
        box-shadow: none;
      }

      .btn-secondary {
        background: #f0f2f5;
        color: #666;
      }

      .btn-secondary:hover {
        background: #e0e0e0;
      }

      /* 表单状态信息 */
      .form-status {
        margin-top: 20px;
        padding: 12px 16px;
        border-radius: 4px;
        font-size: 14px;
        text-align: center;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .form-status.success {
        background: #e8f5e9;
        color: #4caf50;
        border: 1px solid #c8e6c9;
      }

      .form-status.error {
        background: #ffebee;
        color: #f44336;
        border: 1px solid #ffcdd2;
      }

      .form-status.loading {
        background: #e3f2fd;
        color: #2196f3;
        border: 1px solid #bbdefb;
      }

      /* 维修记录列表样式 */
      .repair-list-header {
        display: flex;
        background-color: #f5f5f5;
        padding: 12px 15px;
        border-radius: 8px 8px 0 0;
        font-weight: bold;
        color: #333;
        border-bottom: 2px solid #e0e0e0;
      }

      .repair-list-col {
        flex: 1;
        text-align: center;
      }

      .repair-list-content {
        border: 1px solid #e0e0e0;
        border-top: none;
        border-radius: 0 0 8px 8px;
        overflow: hidden;
      }

      .repair-record {
        display: flex;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
      }

      .repair-record:last-child {
        border-bottom: none;
      }

      .repair-record:hover {
        background-color: #fafafa;
      }

      .repair-record-col {
        flex: 1;
        text-align: center;
      }

      .repair-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #e0e0e0;
      }

      /* 状态样式 */
      .status-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 14px;
        font-weight: 500;
      }

      .status-0 {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
      }

      .status-1 {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .status-2 {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status-3 {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status-4 {
        background-color: #e2e3e5;
        color: #383d41;
        border: 1px solid #d6d8db;
      }

      /* 反馈状态样式 */
      .feedback-status-anon {
        background-color: #e8eaf6;
        color: #3f51b5;
        border: 1px solid #c5cae9;
      }

      .feedback-status-non {
        background-color: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
      }

      /* 分页样式 */
      .pagination-container {
        margin-top: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background-color: #f5f5f5;
        border-radius: 8px;
      }

      .pagination-info {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #666;
      }

      .page-size-select {
        padding: 5px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: white;
        font-size: 14px;
      }

      .pagination-controls {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .pagination-btn {
        padding: 8px 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: white;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
      }

      .pagination-btn:hover:not(:disabled) {
        background-color: #f0f0f0;
        border-color: #ccc;
      }

      .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .page-numbers {
        display: flex;
        gap: 5px;
      }

      .page-btn {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: white;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
        min-width: 32px;
        text-align: center;
      }

      .page-btn:hover:not(.active) {
        background-color: #f0f0f0;
      }

      .page-btn.active {
        background-color: #3f51b5;
        color: white;
        border-color: #3f51b5;
      }

      /* 响应式设计 */
      @media (max-width: 768px) {
        .verify-code-group {
          flex-direction: column;
          gap: 10px;
        }

        .verify-code-right {
          align-items: flex-start;
        }

        .form-actions {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }

        /* 维修记录列表响应式 */
        .repair-list-header,
        .repair-record {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .repair-list-col,
        .repair-record-col {
          text-align: left;
          width: 100%;
        }

        .repair-list-col::before,
        .repair-record-col::before {
          content: attr(data-label) ": ";
          font-weight: bold;
        }

        .repair-list-header .repair-list-col::before {
          display: none;
        }

        /* 分页响应式 */
        .pagination-container {
          flex-direction: column;
          gap: 15px;
          align-items: stretch;
        }

        .pagination-info {
          justify-content: center;
        }

        .pagination-controls {
          justify-content: center;
        }
      }

      @media (max-width: 480px) {
        .repair-image {
          width: 60px;
          height: 60px;
        }

        .page-numbers {
          overflow-x: auto;
          padding: 5px;
        }
      }
    </style>
  </head>
  <body>
    <!-- 顶部导航栏 -->

    <header class="header">
      <div class="header-left">
        <button class="back-button" onclick="history.back()">&lt;</button>
        <h1>学生主页</h1>
      </div>

      <div class="dropdown-container">
        <div
          class="user-icon"
          th:style="'background-image: url(' + ${user.avatarUrl} + ');'"
        ></div>
        <div class="dropdown-menu">
          <button class="dropdown-item" onclick="location.href='/user/info'">
            个人信息
          </button>
          <button class="dropdown-item" onclick="logout()">退出登录</button>
        </div>
      </div>
    </header>

    <!-- 主容器 -->
    <div class="container">
      <!-- 左侧边栏 -->
      <aside class="sidebar">
        <div class="sidebar-profile">
          <div
            class="user-main-icon"
            th:style="'background-image: url(' + ${user.avatarUrl} + ');'"
          ></div>
          <div
            class="sidebar-name"
            id="userSidebarNickname"
            th:text="${user.nickname != null ? user.nickname : user.name}"
          >
            -
          </div>
        </div>
        <nav class="sidebar-menu">
          <a href="#" class="menu-item active" data-view="account">
            <span class="menu-item-left">
              <svg class="menu-icon" viewBox="0 0 24 24">
                <path
                  d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"
                />
              </svg>
              账号管理
            </span>
          </a>
          <a href="#" class="menu-item" data-view="repairs">
            <span class="menu-item-left">
              <svg class="menu-icon" viewBox="0 0 24 24">
                <path
                  d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"
                />
              </svg>
              维修申请记录
            </span>
          </a>
          <a href="#" class="menu-item" data-view="feedbacks">
            <span class="menu-item-left">
              <svg class="menu-icon" viewBox="0 0 24 24">
                <path
                  d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 12h-2v-2h2v2zm0-4h-2V6h2v4z"
                />
              </svg>
              反馈记录
            </span>
          </a>
          <a href="#" class="menu-item" data-view="dormitory-change">
            <span class="menu-item-left">
              <svg class="menu-icon" viewBox="0 0 24 24">
                <path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z" />
              </svg>
              宿舍调换申请记录
            </span>
          </a>
        </nav>
      </aside>

      <!-- 主内容区域 -->
      <main class="main-content">
        <!-- 账号管理视图 -->
        <div id="sidebarViewAccount" class="sidebar-view">
          <div class="content-card">
            <h2 class="card-title">账户信息</h2>

            <!-- 标签页 -->
            <div class="tabs">
              <button
                class="tab active"
                data-tab="basic"
                onclick="switchTab('basic')"
              >
                基本信息
              </button>
              <button
                class="tab"
                data-tab="avatar"
                onclick="switchTab('avatar')"
              >
                修改头像
              </button>
              <button
                class="tab"
                data-tab="password"
                onclick="switchTab('password')"
              >
                密码管理
              </button>
            </div>
            <img
              class="gcc-logo"
              src="http://localhost:8081/img/G%20C%20C@1x.png"
              alt=""
            />

            <!-- 基本信息内容 -->
            <div id="basicInfo" class="tab-content">
              <div class="info-form">
                <div class="form-row">
                  <div class="form-label">姓名：</div>
                  <div class="form-value" id="userName" th:text="${user.name}">
                    -
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-label">昵称：</div>
                  <div class="form-value">
                    <div class="editable-field">
                      <span id="userNickname" th:text="${user.nickname}"
                        >-</span
                      >
                      <button
                        class="edit-button"
                        onclick="editField('nickname')"
                      >
                        修改
                      </button>
                    </div>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-label">学号：</div>
                  <div
                    class="form-value"
                    id="studentNumber"
                    th:text="${user.studentNumber}"
                  >
                    -
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-label">班级：</div>
                  <div
                    class="form-value"
                    id="className"
                    th:text="${user.className}"
                  >
                    -
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-label">UID：</div>
                  <div class="form-value" id="userId" th:text="${user.id}">
                    -
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-label">性别：</div>
                  <div
                    class="form-value"
                    id="userGender"
                    th:text="${user.gender}"
                  >
                    -
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-label">手机号：</div>
                  <div class="form-value">
                    <div class="editable-field">
                      <span id="userPhone" th:text="${user.phone}">-</span>
                      <button class="edit-button" onclick="editField('phone')">
                        修改
                      </button>
                    </div>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-label">宿舍：</div>
                  <div class="form-value" id="dormitory">
                    <span th:text="${user.building}"></span
                    ><span th:text="${user.dormitory}"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- 修改头像内容 -->
            <div id="avatarInfo" class="tab-content" style="display: none">
              <div class="avatar-upload-container">
                <div class="avatar-preview-box">
                  <div
                    class="avatar-preview"
                    id="avatarPreview"
                    th:style="'background-image: url(' + ${user.avatarUrl} + ');'"
                  >
                    <div class="avatar-placeholder">
                      <div class="avatar-plus-icon">+</div>
                      <div class="avatar-placeholder-text">添加图片</div>
                    </div>
                  </div>
                  <input
                    type="file"
                    id="avatarFileInput"
                    accept="image/jpeg, image/png, image/gif, image/webp"
                    style="display: none"
                  />
                </div>
                <div class="avatar-upload-info">
                  <p class="avatar-info-text">
                    支持JPG、PNG、GIF、WEBP格式，文件大小不超过5MB
                  </p>
                  <button class="avatar-upload-button" onclick="uploadAvatar()">
                    上传头像
                  </button>
                  <div id="uploadStatus" class="upload-status"></div>
                </div>
              </div>
            </div>

            <!-- 密码管理内容 -->
            <div id="passwordInfo" class="tab-content" style="display: none">
              <div class="password-change-form">
                <div class="form-group">
                  <label for="oldPassword" class="form-label">旧密码</label>
                  <div class="input-wrapper">
                    <input
                      type="password"
                      id="oldPassword"
                      class="form-input"
                      placeholder="请输入旧密码"
                      required
                      minlength="6"
                      maxlength="20"
                    />
                  </div>
                </div>

                <div class="form-group">
                  <label for="newPassword" class="form-label">新密码</label>
                  <div class="input-wrapper">
                    <input
                      type="password"
                      id="newPassword"
                      class="form-input"
                      placeholder="请输入新密码（6-20位）"
                      required
                      minlength="6"
                      maxlength="20"
                    />
                  </div>
                </div>

                <div class="form-group">
                  <label for="confirmPassword" class="form-label"
                    >确认新密码</label
                  >
                  <div class="input-wrapper">
                    <input
                      type="password"
                      id="confirmPassword"
                      class="form-input"
                      placeholder="请再次输入新密码"
                      required
                      minlength="6"
                      maxlength="20"
                    />
                  </div>
                  <div id="passwordMismatch" class="error-message"></div>
                </div>

                <div class="form-group verify-code-group">
                  <div class="verify-code-left">
                    <label for="verifyCode" class="form-label">验证码</label>
                    <div class="input-wrapper">
                      <input
                        type="text"
                        id="verifyCode"
                        class="form-input"
                        placeholder="请输入验证码"
                        required
                        minlength="4"
                        maxlength="4"
                      />
                    </div>
                  </div>
                  <div class="verify-code-right">
                    <img
                      id="verifyCodeImg"
                      src=""
                      alt="验证码"
                      class="verify-code-img"
                    />
                    <span
                      id="refreshVerifyCode"
                      class="refresh-verify-code"
                      onclick="refreshVerifyCode()"
                    >
                      刷新
                    </span>
                  </div>
                </div>

                <div class="form-actions">
                  <button
                    type="button"
                    class="btn btn-primary"
                    id="changePasswordBtn"
                    onclick="changePassword()"
                  >
                    确认修改
                  </button>
                  <button
                    type="button"
                    class="btn btn-secondary"
                    onclick="resetPasswordForm()"
                  >
                    重置
                  </button>
                </div>

                <div id="passwordChangeStatus" class="form-status"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- 维修申请记录视图 -->
        <div id="sidebarViewRepairs" class="sidebar-view" style="display: none">
          <div class="content-card">
            <h2 class="card-title">维修申请记录</h2>

            <!-- 维修记录列表 -->
            <div id="repairListContainer">
              <!-- 列表头部 -->
              <div class="repair-list-header">
                <div class="repair-list-col">时间</div>
                <div class="repair-list-col">地点</div>
                <div class="repair-list-col">描述</div>
                <div class="repair-list-col">图片</div>
                <div class="repair-list-col">状态</div>
              </div>

              <!-- 列表内容 -->
              <div id="repairRecordsList" class="repair-list-content">
                <!-- 记录将通过JavaScript动态生成 -->
              </div>

              <!-- 分页控件 -->
              <div class="pagination-container">
                <div class="pagination-info">
                  <span>共 <span id="totalRecords">0</span> 条记录</span>
                  <select id="pageSizeSelect" class="page-size-select">
                    <option value="5">每页 5 条</option>
                    <option value="10">每页 10 条</option>
                    <option value="20">每页 20 条</option>
                  </select>
                </div>
                <div class="pagination-controls">
                  <button id="prevPage" class="pagination-btn" disabled>
                    上一页
                  </button>
                  <div class="page-numbers">
                    <!-- 页码按钮将通过JavaScript动态生成 -->
                  </div>
                  <button id="nextPage" class="pagination-btn" disabled>
                    下一页
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 反馈记录视图 -->
        <div
          id="sidebarViewFeedbacks"
          class="sidebar-view"
          style="display: none"
        >
          <div class="content-card">
            <h2 class="card-title">反馈记录</h2>
            <div id="feedbackListContainer">
              <div class="repair-list-header">
                <div class="repair-list-col">时间</div>
                <div class="repair-list-col">描述</div>
                <div class="repair-list-col">图片</div>
                <div class="repair-list-col">状态</div>
              </div>

              <div id="feedbackRecordsList" class="repair-list-content">
                <!-- 反馈记录将通过 JavaScript 动态生成 -->
              </div>

              <div class="pagination-container">
                <div class="pagination-info">
                  <span
                    >共 <span id="feedbackTotalRecords">0</span> 条记录</span
                  >
                  <select id="feedbackPageSizeSelect" class="page-size-select">
                    <option value="5">每页 5 条</option>
                    <option value="10">每页 10 条</option>
                    <option value="20">每页 20 条</option>
                  </select>
                </div>
                <div class="pagination-controls">
                  <button id="feedbackPrevPage" class="pagination-btn" disabled>
                    上一页
                  </button>
                  <div class="page-numbers feedback-page-numbers">
                    <!-- 页码按钮通过 JS 生成 -->
                  </div>
                  <button id="feedbackNextPage" class="pagination-btn" disabled>
                    下一页
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 宿舍调换申请记录视图 -->
        <div
          id="sidebarViewDormitoryChange"
          class="sidebar-view"
          style="display: none"
        >
          <div class="content-card">
            <h2 class="card-title">宿舍调换申请记录</h2>
            <div id="dormChangeListContainer">
              <div class="repair-list-header">
                <div class="repair-list-col">时间</div>
                <div class="repair-list-col">地点</div>
                <div class="repair-list-col">理由</div>
                <div class="repair-list-col">状态</div>
              </div>

              <div id="dormChangeRecordsList" class="repair-list-content">
                <!-- 宿舍调换记录将通过 JavaScript 动态生成 -->
              </div>

              <div class="pagination-container">
                <div class="pagination-info">
                  <span>共 <span id="dormTotalRecords">0</span> 条记录</span>
                  <select id="dormPageSizeSelect" class="page-size-select">
                    <option value="5">每页 5 条</option>
                    <option value="10">每页 10 条</option>
                    <option value="20">每页 20 条</option>
                  </select>
                </div>
                <div class="pagination-controls">
                  <button id="dormPrevPage" class="pagination-btn" disabled>
                    上一页
                  </button>
                  <div class="page-numbers dorm-page-numbers">
                    <!-- 页码按钮通过 JS 生成 -->
                  </div>
                  <button id="dormNextPage" class="pagination-btn" disabled>
                    下一页
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- 编辑模态框 -->
    <div class="modal" id="editModal">
      <div class="modal-content">
        <div class="modal-header" id="modalTitle">修改信息</div>
        <div class="modal-body">
          <input
            type="text"
            class="modal-input"
            id="modalInput"
            placeholder="请输入新的值"
          />
        </div>
        <div class="modal-footer">
          <button class="modal-button secondary" onclick="closeModal()">
            取消
          </button>
          <button class="modal-button primary" onclick="saveEdit()">
            保存
          </button>
        </div>
      </div>
    </div>

    <script>
      // 获取用户信息并填充页面
      window.addEventListener("DOMContentLoaded", function () {
        fetchUserInfo();
        refreshVerifyCode();
      });
      /************************************************************************************************************************************************/
      /*************************************************************获取用户信息***********************************************************************/
      /************************************************************************************************************************************************/
      // 获取用户信息
      async function fetchUserInfo() {
        try {
          const response = await fetch("/user/user/my", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + localStorage.getItem("token"),
              // 如果需要 token，在这里添加
              // 'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
          });

          const result = await response.json();
          console.log(result);
          if (result.code === "200" && result.data) {
            const user = result.data;

            // 更新个人信息
            document.getElementById("userName").textContent = user.name || "-";
            document.getElementById("userNickname").textContent =
              user.nickname || "-";
            document.getElementById("userSidebarNickname").textContent =
              user.nickname || "-";
            document.getElementById("studentNumber").textContent =
              user.studentNumber || "-";
            document.getElementById("className").textContent =
              user.className || "-";
            document.getElementById("userId").textContent = user.userId || "-";
            document.getElementById("userPhone").textContent =
              user.phone || "-";
            document.getElementById("dormitory").textContent =
              (user.building || "") + (user.dormitory || "");
            document.getElementById("userGender").textContent =
              user.gender || "-";
            // 更新头像
            if (user.avatarUrl) {
              const userIcon = document.querySelector(".user-icon");
              const userMainIcon = document.querySelector(".user-main-icon");
              if (userIcon) {
                userIcon.style.backgroundImage = `url('${user.avatarUrl.trim()}')`;
                userMainIcon.style.backgroundImage = `url('${user.avatarUrl.trim()}')`;
              }
            }
          } else {
            console.error("获取用户信息失败:", result.message);
            showError();
          }
        } catch (error) {
          console.error("获取用户信息出错:", error);
          showError();
        }
      }

      // 显示错误信息
      function showError() {
        document.getElementById("userName").textContent = "获取失败";
        document.getElementById("userNickname").textContent = "获取失败";
        document.getElementById("studentNumber").textContent = "获取失败";
        document.getElementById("className").textContent = "获取失败";
        document.getElementById("phone").textContent = "获取失败";
        document.getElementById("dormitory").textContent = "获取失败";
      }

      // 当前编辑的字段
      let currentEditField = null;

      // 切换标签页
      function switchTab(tabName) {
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        document
          .querySelector(`[data-tab="${tabName}"]`)
          .classList.add("active");

        document.getElementById("basicInfo").style.display =
          tabName === "basic" ? "block" : "none";
        document.getElementById("avatarInfo").style.display =
          tabName === "avatar" ? "block" : "none";
        document.getElementById("passwordInfo").style.display =
          tabName === "password" ? "block" : "none";
      }

      // 编辑字段
      function editField(fieldName) {
        currentEditField = fieldName;
        const modal = document.getElementById("editModal");
        const modalTitle = document.getElementById("modalTitle");
        const modalInput = document.getElementById("modalInput");

        if (fieldName === "nickname") {
          modalTitle.textContent = "修改昵称";
          modalInput.value =
            document.getElementById("userNickname").textContent;
        } else if (fieldName === "phone") {
          modalTitle.textContent = "修改手机号";
          modalInput.value = document.getElementById("userPhone").textContent;
        }

        modal.classList.add("show");
        modalInput.focus();
      }

      // 关闭模态框
      function closeModal() {
        document.getElementById("editModal").classList.remove("show");
        currentEditField = null;
      }

      // 保存编辑
      async function saveEdit() {
        const newValue = document.getElementById("modalInput").value.trim();

        if (!newValue) {
          alert("请输入有效的值");
          return;
        }

        if (currentEditField === "nickname") {
          if (newValue.length > 20) {
            alert("昵称长度不能超过20个字符");
            return;
          }
        } else if (currentEditField === "phone") {
          if (!/^1[3-9]\d{9}$/.test(newValue)) {
            alert("请输入有效的手机号码");
            return;
          }
        }

        try {
          let url = "";
          let requestBody = "";

          if (currentEditField === "nickname") {
            // 修改昵称接口: PUT /user/my?nickname=xxx
            url = "/user/my?nickname=" + encodeURIComponent(newValue);
          } else if (currentEditField === "phone") {
            // 修改手机号接口: PUT /user/changePhone?newPhone=xxx
            url = "/user/changePhone?newPhone=" + encodeURIComponent(newValue);
          }

          const response = await fetch(url, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });

          const result = await response.json();
          if (result.code === "200" || result.code === 200) {
            if (currentEditField === "nickname") {
              document.getElementById("userNickname").textContent = newValue;
              document.getElementById("userSidebarNickname").textContent =
                newValue;
            } else if (currentEditField === "phone") {
              document.getElementById("userPhone").textContent = newValue;
            }
            alert("修改成功！");
            closeModal();
          } else {
            alert("修改失败：" + result.message);
          }
        } catch (error) {
          console.error("更新用户信息失败:", error);
          alert("修改失败，请稍后重试");
        }
      }

      // 点击模态框外部关闭
      document
        .getElementById("editModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeModal();
          }
        });

      // 回车键保存
      document
        .getElementById("modalInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            saveEdit();
          }
        });

      function setActiveMenuItem(activeItem) {
        document
          .querySelectorAll(".menu-item")
          .forEach((i) => i.classList.remove("active"));
        activeItem.classList.add("active");
      }

      function switchSidebarView(view) {
        const viewMap = {
          account: document.getElementById("sidebarViewAccount"),
          repairs: document.getElementById("sidebarViewRepairs"),
          feedbacks: document.getElementById("sidebarViewFeedbacks"),
          "dormitory-change": document.getElementById(
            "sidebarViewDormitoryChange"
          ),
        };

        Object.values(viewMap).forEach((el) => {
          if (el) {
            el.style.display = "none";
          }
        });

        const target = viewMap[view] || viewMap.account;
        if (target) {
          target.style.display = "block";
        }
      }

      // 侧边栏菜单交互：不跳转/不刷新，动态切换右侧内容
      document.querySelectorAll(".menu-item").forEach((item) => {
        item.addEventListener("click", function (e) {
          e.preventDefault();
          setActiveMenuItem(this);
          switchSidebarView(this.dataset.view || "account");
        });
      });

      // 首次加载时与默认 active 同步
      (function initSidebarView() {
        const activeItem = document.querySelector(".menu-item.active");
        switchSidebarView(activeItem?.dataset.view || "account");
      })();

      // 退出登录功能
      function logout() {
        if (confirm("确定要退出登录吗？")) {
          localStorage.removeItem("token");
          alert("已退出登录");
          location.href = "/users/login";
        }
      }
      /************************************************************************************************************************************************/
      /*************************************************************获取用户信息***********************************************************************/
      /******************************************************包含文件选择、预览、上传功能***************************************************************/
      /************************************************************************************************************************************************/
      let selectedAvatarFile = null;

      // 监听文件选择事件
      document
        .getElementById("avatarFileInput")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            // 验证文件类型
            const allowedTypes = [
              "image/jpeg",
              "image/png",
              "image/gif",
              "image/webp",
            ];
            if (!allowedTypes.includes(file.type)) {
              showUploadStatus(
                "不支持的文件类型，请选择JPG、PNG、GIF或WEBP格式",
                "error"
              );
              return;
            }

            // 验证文件大小（5MB）
            const maxSize = 5 * 1024 * 1024;
            if (file.size > maxSize) {
              showUploadStatus("文件大小不能超过5MB", "error");
              return;
            }

            selectedAvatarFile = file;
            previewAvatar(file);
            showUploadStatus("");
          }
        });

      // 预览头像
      function previewAvatar(file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const avatarPreview = document.getElementById("avatarPreview");
          avatarPreview.style.backgroundImage = `url('${e.target.result}')`;
          avatarPreview.classList.add("has-image");
        };
        reader.readAsDataURL(file);
      }

      // 上传头像
      async function uploadAvatar() {
        console.log("上传头像函数触发");
        if (!selectedAvatarFile) {
          console.log("请先选择图片");
          showUploadStatus("请先选择图片", "error");
          return;
        }

        const uploadButton = document.querySelector(".avatar-upload-button");
        uploadButton.disabled = true;
        showUploadStatus("正在上传...", "loading");

        try {
          const formData = new FormData();
          formData.append("avatarFile", selectedAvatarFile);

          const response = await fetch("/user/user/avatar", {
            method: "POST",
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
            body: formData,
          });

          const result = await response.json();

          if (result.code === "200") {
            showUploadStatus("上传成功", "success");

            // 更新页面上的头像
            if (result.data && result.data.avatarUrl) {
              const avatarUrl = result.data.avatarUrl;
              // 更新顶部导航栏头像
              const userIcon = document.querySelector(".user-icon");
              if (userIcon) {
                userIcon.style.backgroundImage = `url('${avatarUrl.trim()}')`;
              }
              // 更新左侧边栏头像
              const userMainIcon = document.querySelector(".user-main-icon");
              if (userMainIcon) {
                userMainIcon.style.backgroundImage = `url('${avatarUrl.trim()}')`;
              }
              // 更新预览头像
              const avatarPreview = document.getElementById("avatarPreview");
              if (avatarPreview) {
                avatarPreview.style.backgroundImage = `url('${avatarUrl.trim()}')`;
              }
            }

            // 3秒后清除成功提示
            setTimeout(() => {
              showUploadStatus("");
            }, 3000);
          } else {
            showUploadStatus(
              "上传失败: " + (result.message || "未知错误"),
              "error"
            );
          }
        } catch (error) {
          console.error("上传头像出错:", error);
          showUploadStatus("上传失败，请稍后重试", "error");
        } finally {
          uploadButton.disabled = false;
        }
      }

      // 显示上传状态
      function showUploadStatus(message, type) {
        const statusElement = document.getElementById("uploadStatus");
        statusElement.textContent = message;
        statusElement.className = "upload-status";
        if (type) {
          statusElement.classList.add(type);
        }
      }

      // 点击预览区域触发文件选择
      document
        .getElementById("avatarPreview")
        .addEventListener("click", function () {
          document.getElementById("avatarFileInput").click();
        });
      /************************************************************************************************************************************************/
      /*************************************************************修改密码***************************************************************************/
      /************************************************************************************************************************************************/
      document.addEventListener("DOMContentLoaded", function () {
        // 监听新密码和确认密码的输入事件，实时验证一致性
        const newPasswordInput = document.getElementById("newPassword");
        const confirmPasswordInput = document.getElementById("confirmPassword");

        newPasswordInput.addEventListener("input", validatePasswordMatch);
        confirmPasswordInput.addEventListener("input", validatePasswordMatch);
      });

      // 验证新密码和确认密码是否一致
      function validatePasswordMatch() {
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;
        const passwordMismatchError =
          document.getElementById("passwordMismatch");
        const changePasswordBtn = document.getElementById("changePasswordBtn");

        if (newPassword && confirmPassword && newPassword !== confirmPassword) {
          passwordMismatchError.textContent = "两次输入的新密码不一致";
          changePasswordBtn.disabled = true;
        } else {
          passwordMismatchError.textContent = "";
          changePasswordBtn.disabled = false;
        }
      }

      // 刷新验证码
      let verifyCodeObjectUrl = null;

      async function loadVerifyCodeImage() {
        const verifyCodeImg = document.getElementById("verifyCodeImg");
        const token = localStorage.getItem("token");

        if (!token) {
          verifyCodeImg.removeAttribute("src");
          return;
        }

        const url = "/user/generateVerifyCode";

        try {
          const response = await fetch(url, {
            method: "GET",
            headers: {
              Authorization: "Bearer " + token,
            },
            cache: "no-store",
          });

          if (!response.ok) {
            throw new Error("获取验证码失败，HTTP " + response.status);
          }

          const blob = await response.blob();
          if (verifyCodeObjectUrl) {
            URL.revokeObjectURL(verifyCodeObjectUrl);
          }
          verifyCodeObjectUrl = URL.createObjectURL(blob);
          verifyCodeImg.src = verifyCodeObjectUrl;
        } catch (error) {
          console.error("获取验证码图片出错:", error);
        }
      }

      function refreshVerifyCode() {
        loadVerifyCodeImage();
      }

      window.addEventListener("beforeunload", function () {
        if (verifyCodeObjectUrl) {
          URL.revokeObjectURL(verifyCodeObjectUrl);
          verifyCodeObjectUrl = null;
        }
      });

      // 重置表单
      function resetPasswordForm() {
        document.getElementById("oldPassword").value = "";
        document.getElementById("newPassword").value = "";
        document.getElementById("confirmPassword").value = "";
        document.getElementById("verifyCode").value = "";
        document.getElementById("passwordMismatch").textContent = "";
        document.getElementById("passwordChangeStatus").textContent = "";
        document.getElementById("passwordChangeStatus").className =
          "form-status";
        refreshVerifyCode();
      }
      /************************************************************************************************************************************************/
      /*************************************************************密码修改功能***********************************************************************/
      /************************************************************************************************************************************************/
      // 提交密码修改表单
      async function changePassword() {
        const oldPassword = document.getElementById("oldPassword").value.trim();
        const newPassword = document.getElementById("newPassword").value.trim();
        const confirmPassword = document
          .getElementById("confirmPassword")
          .value.trim();
        const verifyCode = document.getElementById("verifyCode").value.trim();
        const statusElement = document.getElementById("passwordChangeStatus");
        const changePasswordBtn = document.getElementById("changePasswordBtn");

        // 前端验证
        if (!oldPassword || !newPassword || !confirmPassword || !verifyCode) {
          showPasswordStatus("请填写所有必填字段", "error");
          return;
        }

        if (newPassword !== confirmPassword) {
          showPasswordStatus("两次输入的新密码不一致", "error");
          return;
        }

        if (newPassword.length < 6 || newPassword.length > 20) {
          showPasswordStatus("新密码长度必须在6-20位之间", "error");
          return;
        }

        if (verifyCode.length !== 4) {
          showPasswordStatus("验证码必须为4位", "error");
          return;
        }

        // 禁用按钮，显示加载状态
        changePasswordBtn.disabled = true;
        showPasswordStatus("正在修改密码...", "loading");

        try {
          const response = await fetch("/user/user/change-password", {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
            body: JSON.stringify({
              oldPassword,
              newPassword,
              confirmPassword,
              verifyCode,
            }),
          });

          const result = await response.json();

          if (result.code === "200") {
            showPasswordStatus("密码修改成功", "success");
            // 清除本地存储的 token
            localStorage.removeItem("token");
            // 2秒后跳转到登录页
            setTimeout(() => {
              window.location.href = "/users/login";
            }, 2000);
            // 重置表单
            setTimeout(() => {
              resetPasswordForm();
            }, 2000);
          } else {
            showPasswordStatus(result.message || "密码修改失败", "error");
            // 刷新验证码
            refreshVerifyCode();
          }
        } catch (error) {
          console.error("修改密码出错:", error);
          showPasswordStatus("网络错误，请稍后重试", "error");
          // 刷新验证码
          refreshVerifyCode();
        } finally {
          changePasswordBtn.disabled = false;
        }
      }

      // 显示密码修改状态
      function showPasswordStatus(message, type) {
        const statusElement = document.getElementById("passwordChangeStatus");
        statusElement.textContent = message;
        statusElement.className = `form-status ${type}`;
      }

      // 重置密码修改表单
      function resetPasswordForm() {
        document.getElementById("oldPassword").value = "";
        document.getElementById("newPassword").value = "";
        document.getElementById("confirmPassword").value = "";
        document.getElementById("verifyCode").value = "";
        showPasswordStatus("", "");
      }

      /************************************************************************************************************************************************/
      /*************************************************************维修申请记录管理*******************************************************************/
      /************************************************************************************************************************************************/
      // 维修记录相关变量
      let currentPage = 1;
      let pageSize = 5;
      let totalRecords = 0;
      let totalPages = 0;

      // 反馈记录相关变量
      let feedbackCurrentPage = 1;
      let feedbackPageSize = 5;
      let feedbackTotalRecords = 0;
      let feedbackTotalPages = 0;

      // 宿舍调换记录相关变量
      let dormCurrentPage = 1;
      let dormPageSize = 5;
      let dormTotalRecords = 0;
      let dormTotalPages = 0;

      // 状态映射
      const statusMap = {
        0: "申请中",
        1: "已受理",
        2: "已完成",
        3: "已拒绝",
        4: "已取消",
      };

      const dormStatusMap = {
        0: "申请中",
        1: "已通过",
        2: "已拒绝",
      };

      // 监听侧边栏切换，当切换到维修记录视图时加载数据
      function switchSidebarView(view) {
        const viewMap = {
          account: document.getElementById("sidebarViewAccount"),
          repairs: document.getElementById("sidebarViewRepairs"),
          feedbacks: document.getElementById("sidebarViewFeedbacks"),
          "dormitory-change": document.getElementById(
            "sidebarViewDormitoryChange"
          ),
        };

        Object.values(viewMap).forEach((el) => {
          if (el) {
            el.style.display = "none";
          }
        });

        const target = viewMap[view] || viewMap.account;
        if (target) {
          target.style.display = "block";

          // 当切换到维修记录视图时，加载维修记录
          if (view === "repairs") {
            loadRepairRecords();
          }

          if (view === "feedbacks") {
            loadFeedbackRecords();
          }

          if (view === "dormitory-change") {
            loadDormChangeRecords();
          }
        }
      }

      // 获取维修记录
      async function getRepairRecords(pageNum, pageSize) {
        try {
          const response = await fetch(
            `/user/repairs/my?pageNum=${pageNum}&pageSize=${pageSize}`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
            }
          );

          const result = await response.json();

          if (result.code === "200") {
            return {
              total: result.data.total,
              records: result.data.records || [],
            };
          } else {
            console.error("获取维修记录失败:", result.message);
            return { total: 0, records: [] };
          }
        } catch (error) {
          console.error("获取维修记录出错:", error);
          return { total: 0, records: [] };
        }
      }

      // 加载维修记录
      async function loadRepairRecords() {
        const data = await getRepairRecords(currentPage, pageSize);
        totalRecords = data.total;
        totalPages = Math.ceil(totalRecords / pageSize);

        renderRepairRecords(data.records);
        renderPagination();
        updatePaginationInfo();
      }

      // 渲染维修记录
      function renderRepairRecords(records) {
        const listContainer = document.getElementById("repairRecordsList");

        if (records.length === 0) {
          listContainer.innerHTML = `
            <div class="repair-record">
              <div class="repair-record-col" style="flex: 1 1 100%; text-align: center; padding: 30px;">
                暂无维修记录
              </div>
            </div>
          `;
          return;
        }

        listContainer.innerHTML = records
          .map((record) => {
            const firstImage = getFirstImageUrl(record);
            return `
          <div class="repair-record" onclick="goRepairDetail(${
            record.orderId != null ? record.orderId : "null"
          })" style="cursor:pointer;">
            <div class="repair-record-col" data-label="时间">${
              record.createdTime || "-"
            }</div>
            <div class="repair-record-col" data-label="地点">${
              record.address || "-"
            }</div>
            <div class="repair-record-col" data-label="描述">${
              record.description || "-"
            }</div>
            <div class="repair-record-col" data-label="图片">
              ${
                firstImage
                  ? '<img src="' +
                    firstImage +
                    '" alt="维修图片" class="repair-image">'
                  : "-"
              }
            </div>
            <div class="repair-record-col" data-label="状态">
              <span class="status-badge status-${record.processStatus}">${
              statusMap[record.processStatus]
            }</span>
            </div>
          </div>
        `;
          })
          .join("");
      }

      function getFirstImageUrl(record) {
        if (!record) return "";
        if (Array.isArray(record.imageUrls) && record.imageUrls.length > 0) {
          return record.imageUrls[0];
        }
        if (typeof record.imageUrls === "string") {
          const arr = record.imageUrls
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean);
          if (arr.length > 0) return arr[0];
        }
        return record.imageUrl || "";
      }

      function goRepairDetail(orderId) {
        if (!orderId) return;
        const search = new URLSearchParams({ orderId }).toString();
        window.location.href = `/user/repair/item?${search}`;
      }

      // 更新分页信息
      function updatePaginationInfo() {
        document.getElementById("totalRecords").textContent = totalRecords;
        document.getElementById("pageSizeSelect").value = pageSize;
      }

      // 渲染分页控件
      function renderPagination() {
        const pageNumbersContainer = document.querySelector(".page-numbers");
        const prevPageBtn = document.getElementById("prevPage");
        const nextPageBtn = document.getElementById("nextPage");

        // 更新按钮状态
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages;

        // 生成页码按钮
        pageNumbersContainer.innerHTML = "";

        if (totalPages <= 1) {
          return;
        }

        // 页码范围计算
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);

        // 确保显示5个页码
        if (endPage - startPage < 4) {
          if (startPage === 1) {
            endPage = Math.min(totalPages, startPage + 4);
          } else if (endPage === totalPages) {
            startPage = Math.max(1, endPage - 4);
          }
        }

        // 首页按钮
        if (startPage > 1) {
          const firstPageBtn = createPageButton(1);
          pageNumbersContainer.appendChild(firstPageBtn);

          if (startPage > 2) {
            const ellipsis1 = document.createElement("span");
            ellipsis1.textContent = "...";
            ellipsis1.className = "pagination-ellipsis";
            pageNumbersContainer.appendChild(ellipsis1);
          }
        }

        // 中间页码按钮
        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = createPageButton(i);
          pageNumbersContainer.appendChild(pageBtn);
        }

        // 末页按钮
        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            const ellipsis2 = document.createElement("span");
            ellipsis2.textContent = "...";
            ellipsis2.className = "pagination-ellipsis";
            pageNumbersContainer.appendChild(ellipsis2);
          }

          const lastPageBtn = createPageButton(totalPages);
          pageNumbersContainer.appendChild(lastPageBtn);
        }
      }

      // 创建页码按钮
      function createPageButton(pageNum) {
        const button = document.createElement("button");
        button.className = `page-btn ${
          pageNum === currentPage ? "active" : ""
        }`;
        button.textContent = pageNum;
        button.addEventListener("click", () => {
          currentPage = pageNum;
          loadRepairRecords();
        });
        return button;
      }

      // 初始化维修记录相关事件监听
      function initRepairRecordEvents() {
        // 上一页按钮
        document.getElementById("prevPage").addEventListener("click", () => {
          if (currentPage > 1) {
            currentPage--;
            loadRepairRecords();
          }
        });

        // 下一页按钮
        document.getElementById("nextPage").addEventListener("click", () => {
          if (currentPage < totalPages) {
            currentPage++;
            loadRepairRecords();
          }
        });

        // 每页记录数变化
        document
          .getElementById("pageSizeSelect")
          .addEventListener("change", (e) => {
            pageSize = parseInt(e.target.value);
            currentPage = 1;
            loadRepairRecords();
          });
      }

      // 初始化所有事件
      function initAllEvents() {
        initRepairRecordEvents();
        initFeedbackRecordEvents();
        initDormChangeRecordEvents();
      }

      // 页面加载时初始化
      window.addEventListener("DOMContentLoaded", () => {
        initAllEvents();
      });

      /************************************************************************************************************************************************/
      /*************************************************************反馈记录管理***********************************************************************/
      /************************************************************************************************************************************************/

      // 获取反馈记录
      async function getFeedbackRecords(pageNum, pageSize) {
        try {
          const response = await fetch(
            `/user/feedbacks/my?pageNum=${pageNum}&pageSize=${pageSize}`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
            }
          );

          const result = await response.json();

          if (result.code === "200") {
            return {
              total: result.data.total,
              records: result.data.records || [],
            };
          } else {
            console.error("获取反馈记录失败:", result.message);
            return { total: 0, records: [] };
          }
        } catch (error) {
          console.error("获取反馈记录出错:", error);
          return { total: 0, records: [] };
        }
      }

      // 加载反馈记录
      async function loadFeedbackRecords() {
        const data = await getFeedbackRecords(
          feedbackCurrentPage,
          feedbackPageSize
        );
        feedbackTotalRecords = data.total;
        feedbackTotalPages = Math.ceil(feedbackTotalRecords / feedbackPageSize);

        renderFeedbackRecords(data.records);
        renderFeedbackPagination();
        updateFeedbackPaginationInfo();
      }

      // 日期格式化函数，只保留年月日
      function formatDate(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      function formatDateTime(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString.replace(/-/g, "/"));
        if (Number.isNaN(date.getTime())) return dateString;
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        const hours = String(date.getHours()).padStart(2, "0");
        const minutes = String(date.getMinutes()).padStart(2, "0");
        const seconds = String(date.getSeconds()).padStart(2, "0");
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
      }

      // 渲染反馈记录
      function renderFeedbackRecords(records) {
        const listContainer = document.getElementById("feedbackRecordsList");

        if (records.length === 0) {
          listContainer.innerHTML = `
            <div class="repair-record">
              <div class="repair-record-col" style="flex: 1 1 100%; text-align: center; padding: 30px;">
                暂无反馈记录
              </div>
            </div>
          `;
          return;
        }

        listContainer.innerHTML = records
          .map((record) => {
            const isAnon = Number(record.isAnonymous) === 1;
            const statusClass = isAnon
              ? "feedback-status-anon"
              : "feedback-status-non";
            const statusText = isAnon ? "实名" : "匿名";

            const imageUrls = (record.imageUrls || "")
              .split(",")
              .map((u) => u.trim())
              .filter(Boolean);
            const firstImage = imageUrls[0] || "";

            return `
              <div class="repair-record" style="cursor:pointer;" onclick="goFeedbackDetail(${
                record.feedbackId || "null"
              })">
                <div class="repair-record-col" data-label="时间">${formatDate(
                  record.createdTime
                )}</div>
                <div class="repair-record-col" data-label="描述">${
                  record.content || "-"
                }</div>
                <div class="repair-record-col" data-label="图片">
                  ${
                    firstImage
                      ? '<img src="' +
                        firstImage +
                        '" alt="反馈图片" class="repair-image">'
                      : "-"
                  }
                </div>
                <div class="repair-record-col" data-label="状态">
                  <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
              </div>
            `;
          })
          .join("");
      }

      function goFeedbackDetail(feedbackId) {
        if (!feedbackId) return;
        const search = new URLSearchParams({ feedbackId }).toString();
        window.location.href = `/user/feedback/item?${search}`;
      }

      // 更新分页信息（反馈）
      function updateFeedbackPaginationInfo() {
        document.getElementById("feedbackTotalRecords").textContent =
          feedbackTotalRecords;
        document.getElementById("feedbackPageSizeSelect").value =
          feedbackPageSize;
      }

      // 渲染分页（反馈）
      function renderFeedbackPagination() {
        const pageNumbersContainer = document.querySelector(
          ".feedback-page-numbers"
        );
        const prevPageBtn = document.getElementById("feedbackPrevPage");
        const nextPageBtn = document.getElementById("feedbackNextPage");

        prevPageBtn.disabled = feedbackCurrentPage === 1;
        nextPageBtn.disabled = feedbackCurrentPage === feedbackTotalPages;

        pageNumbersContainer.innerHTML = "";

        if (feedbackTotalPages <= 1) {
          return;
        }

        let startPage = Math.max(1, feedbackCurrentPage - 2);
        let endPage = Math.min(feedbackTotalPages, feedbackCurrentPage + 2);

        if (endPage - startPage < 4) {
          if (startPage === 1) {
            endPage = Math.min(feedbackTotalPages, startPage + 4);
          } else if (endPage === feedbackTotalPages) {
            startPage = Math.max(1, endPage - 4);
          }
        }

        if (startPage > 1) {
          const firstPageBtn = createFeedbackPageButton(1);
          pageNumbersContainer.appendChild(firstPageBtn);

          if (startPage > 2) {
            const ellipsis1 = document.createElement("span");
            ellipsis1.textContent = "...";
            ellipsis1.className = "pagination-ellipsis";
            pageNumbersContainer.appendChild(ellipsis1);
          }
        }

        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = createFeedbackPageButton(i);
          pageNumbersContainer.appendChild(pageBtn);
        }

        if (endPage < feedbackTotalPages) {
          if (endPage < feedbackTotalPages - 1) {
            const ellipsis2 = document.createElement("span");
            ellipsis2.textContent = "...";
            ellipsis2.className = "pagination-ellipsis";
            pageNumbersContainer.appendChild(ellipsis2);
          }

          const lastPageBtn = createFeedbackPageButton(feedbackTotalPages);
          pageNumbersContainer.appendChild(lastPageBtn);
        }
      }

      // 创建页码按钮（反馈）
      function createFeedbackPageButton(pageNum) {
        const button = document.createElement("button");
        button.className = `page-btn ${
          pageNum === feedbackCurrentPage ? "active" : ""
        }`;
        button.textContent = pageNum;
        button.addEventListener("click", () => {
          feedbackCurrentPage = pageNum;
          loadFeedbackRecords();
        });
        return button;
      }

      // 初始化反馈记录事件
      function initFeedbackRecordEvents() {
        document
          .getElementById("feedbackPrevPage")
          .addEventListener("click", () => {
            if (feedbackCurrentPage > 1) {
              feedbackCurrentPage--;
              loadFeedbackRecords();
            }
          });

        document
          .getElementById("feedbackNextPage")
          .addEventListener("click", () => {
            if (feedbackCurrentPage < feedbackTotalPages) {
              feedbackCurrentPage++;
              loadFeedbackRecords();
            }
          });

        document
          .getElementById("feedbackPageSizeSelect")
          .addEventListener("change", (e) => {
            feedbackPageSize = parseInt(e.target.value);
            feedbackCurrentPage = 1;
            loadFeedbackRecords();
          });
      }

      /************************************************************************************************************************************************/
      /*************************************************************宿舍调换记录管理*******************************************************************/
      /************************************************************************************************************************************************/

      async function getDormChangeRecords(pageNum, pageSize) {
        try {
          const response = await fetch(
            `/user/dormitory/getMyAllChangeDormitory?pageNum=${pageNum}&pageSize=${pageSize}`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
            }
          );

          const result = await response.json();

          if (result.code === "200" || result.code === 200) {
            const data = result.data || {};
            if (Array.isArray(data.records)) {
              return {
                total: data.total || data.records.length || 0,
                records: data.records,
              };
            }
            if (Array.isArray(data)) {
              return { total: data.length, records: data };
            }
          } else {
            console.error("获取宿舍调换记录失败:", result.message);
            return { total: 0, records: [] };
          }
        } catch (error) {
          console.error("获取宿舍调换记录出错:", error);
          return { total: 0, records: [] };
        }
      }

      async function loadDormChangeRecords() {
        const data = await getDormChangeRecords(dormCurrentPage, dormPageSize);
        dormTotalRecords = data.total;
        dormTotalPages = Math.max(
          1,
          Math.ceil(dormTotalRecords / dormPageSize)
        );

        renderDormChangeRecords(data.records);
        renderDormPagination();
        updateDormPaginationInfo();
      }

      function renderDormChangeRecords(records) {
        const listContainer = document.getElementById("dormChangeRecordsList");

        if (!records || records.length === 0) {
          listContainer.innerHTML = `
            <div class="repair-record">
              <div class="repair-record-col" style="flex: 1 1 100%; text-align: center; padding: 30px;">
                暂无宿舍调换记录
              </div>
            </div>
          `;
          return;
        }

        listContainer.innerHTML = records
          .map((item) => {
            const statusText = dormStatusMap[Number(item.status)] || "申请中";
            const statusClass = `status-${item.status ?? 0}`;
            const created = formatDateTime(item.createdTime);
            const oldAddr = item.oldDormAddress || "-";
            const newAddr = item.newDormAddress || "-";
            const reason = item.reason || "-";
            const id = item.dormChangeId || "";
            return `
              <div class="repair-record" style="cursor:pointer;" onclick="goDormChangeDetail(${id})">
                <div class="repair-record-col" data-label="时间">${created}</div>
                <div class="repair-record-col" data-label="地点">
                  <div>原宿舍：${oldAddr}</div>
                  <div>目标宿舍：${newAddr}</div>
                </div>
                <div class="repair-record-col" data-label="理由">${reason}</div>
                <div class="repair-record-col" data-label="状态">
                  <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
              </div>
            `;
          })
          .join("");
      }

      function goDormChangeDetail(dormChangeId) {
        if (!dormChangeId) return;
        const search = new URLSearchParams({ dormChangeId }).toString();
        window.location.href = `/user/changeDormitory/item?${search}`;
      }

      function updateDormPaginationInfo() {
        document.getElementById("dormTotalRecords").textContent =
          dormTotalRecords;
        document.getElementById("dormPageSizeSelect").value = dormPageSize;
      }

      function renderDormPagination() {
        const pageNumbersContainer =
          document.querySelector(".dorm-page-numbers");
        const prevPageBtn = document.getElementById("dormPrevPage");
        const nextPageBtn = document.getElementById("dormNextPage");

        prevPageBtn.disabled = dormCurrentPage === 1;
        nextPageBtn.disabled = dormCurrentPage === dormTotalPages;

        pageNumbersContainer.innerHTML = "";

        if (dormTotalPages <= 1) {
          return;
        }

        let startPage = Math.max(1, dormCurrentPage - 2);
        let endPage = Math.min(dormTotalPages, dormCurrentPage + 2);

        if (endPage - startPage < 4) {
          if (startPage === 1) {
            endPage = Math.min(dormTotalPages, startPage + 4);
          } else if (endPage === dormTotalPages) {
            startPage = Math.max(1, endPage - 4);
          }
        }

        if (startPage > 1) {
          const firstPageBtn = createDormPageButton(1);
          pageNumbersContainer.appendChild(firstPageBtn);

          if (startPage > 2) {
            const ellipsis1 = document.createElement("span");
            ellipsis1.textContent = "...";
            ellipsis1.className = "pagination-ellipsis";
            pageNumbersContainer.appendChild(ellipsis1);
          }
        }

        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = createDormPageButton(i);
          pageNumbersContainer.appendChild(pageBtn);
        }

        if (endPage < dormTotalPages) {
          if (endPage < dormTotalPages - 1) {
            const ellipsis2 = document.createElement("span");
            ellipsis2.textContent = "...";
            ellipsis2.className = "pagination-ellipsis";
            pageNumbersContainer.appendChild(ellipsis2);
          }

          const lastPageBtn = createDormPageButton(dormTotalPages);
          pageNumbersContainer.appendChild(lastPageBtn);
        }
      }

      function createDormPageButton(pageNum) {
        const button = document.createElement("button");
        button.className = `page-btn ${
          pageNum === dormCurrentPage ? "active" : ""
        }`;
        button.textContent = pageNum;
        button.addEventListener("click", () => {
          dormCurrentPage = pageNum;
          loadDormChangeRecords();
        });
        return button;
      }

      function initDormChangeRecordEvents() {
        document
          .getElementById("dormPrevPage")
          .addEventListener("click", () => {
            if (dormCurrentPage > 1) {
              dormCurrentPage--;
              loadDormChangeRecords();
            }
          });

        document
          .getElementById("dormNextPage")
          .addEventListener("click", () => {
            if (dormCurrentPage < dormTotalPages) {
              dormCurrentPage++;
              loadDormChangeRecords();
            }
          });

        document
          .getElementById("dormPageSizeSelect")
          .addEventListener("change", (e) => {
            dormPageSize = parseInt(e.target.value);
            dormCurrentPage = 1;
            loadDormChangeRecords();
          });
      }
    </script>
  </body>
</html>
