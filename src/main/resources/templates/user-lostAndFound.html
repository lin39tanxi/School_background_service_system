<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>校园后勤管理系统</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Microsoft YaHei", Arial, sans-serif;
        background-image: url(http://localhost:8081/img/35e1b763c15645c1a6d674accf959f30.jpg);
        min-height: 100vh;
        background-size: cover;
        background-attachment: fixed;
      }

      /* 顶部导航栏 */
      .header {
        background: #3f51b5;
        color: white;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }
      .back-button {
        background: none;
        border: none;
        color: white;
        font-size: 28px;
        cursor: pointer;
        padding: 5px 15px;
        transition: opacity 0.3s;
      }

      .back-button:hover {
        opacity: 0.8;
      }

      .header-left {
        display: flex;
        align-items: center;
      }

      .header h1 {
        padding-left: 20px;
        font-size: 24px;
        font-weight: normal;
      }

      .user-icon {
        width: 45px;
        height: 45px;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid rgba(255, 255, 255, 0.5);
        overflow: hidden;
      }

      .user-icon:hover {
        transform: scale(1.05);
        border-color: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      }

      /* 下拉菜单容器 */
      .dropdown-container {
        position: relative;
        display: inline-block;
      }

      /* 下拉菜单 */
      .dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 10px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        z-index: 1000;
        width: 150px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
      }

      /* 悬停显示下拉菜单 */
      .dropdown-container:hover .dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      /* 下拉菜单项 */
      .dropdown-item {
        width: 100%;
        padding: 12px 20px;
        background: none;
        border: none;
        text-align: left;
        cursor: pointer;
        color: #333;
        font-size: 14px;
        transition: all 0.2s;
        outline: none;
      }

      /* 下拉菜单项悬停效果 */
      .dropdown-item:hover {
        background: #f5f5f5;
        color: #3f51b5;
      }

      /* 下拉菜单项分隔线 */
      .dropdown-item:not(:last-child) {
        border-bottom: 1px solid #eee;
      }

      /* 主容器 */
      .container {
        display: flex;
        min-height: calc(100vh - 70px);
      }
      .page {
        width: 100%;
        max-width: 1200px;
        margin: 30px auto;
        background: rgba(255, 255, 255, 0.92);
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        padding: 24px 28px;
      }

      .page-title {
        font-size: 22px;
        color: #1f2c4c;
        margin-bottom: 16px;
      }

      .filters {
        background: #f7f8fb;
        border: 1px solid #e4e7f0;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 18px;
      }

      .filter-row {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 10px;
        gap: 10px;
      }

      .filter-label {
        min-width: 52px;
        color: #606a88;
        font-size: 14px;
      }

      .chip-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .filter-chip {
        padding: 8px 12px;
        border-radius: 18px;
        border: 1px solid #d9dff1;
        background: #fff;
        color: #30416b;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
      }

      .filter-chip:hover {
        border-color: #3f51b5;
        color: #3f51b5;
      }

      .filter-chip.active {
        background: #3f51b5;
        color: #fff;
        border-color: #3f51b5;
      }

      .more-toggle {
        border: none;
        background: none;
        color: #3f51b5;
        cursor: pointer;
        font-size: 13px;
      }

      .date-row input {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #d9dff1;
        font-size: 13px;
      }

      .btn {
        padding: 8px 14px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 13px;
      }

      .btn-primary {
        background: #3f51b5;
        color: #fff;
      }

      .btn-ghost {
        background: #fff;
        color: #3f51b5;
        border: 1px solid #d9dff1;
      }

      .table-card {
        border: 1px solid #e4e7f0;
        border-radius: 10px;
        overflow: hidden;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        background: #eef2fb;
      }

      th,
      td {
        padding: 12px 10px;
        font-size: 13px;
        color: #27314d;
        border-bottom: 1px solid #f1f3fa;
        text-align: left;
      }

      tbody tr:hover {
        background: #f9fbff;
      }

      .status-tag {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
      }

      .status-pending {
        background: #fff6e5;
        color: #e69500;
      }

      .status-done {
        background: #e8f8ed;
        color: #34a853;
      }

      .item-img {
        width: 72px;
        height: 48px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #e4e7f0;
      }

      .empty-row {
        text-align: center;
        color: #8a92a6;
      }

      .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 10px;
        background: #f7f8fb;
      }

      .pager {
        display: inline-flex;
        gap: 8px;
      }

      .pager button {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #d9dff1;
        background: #fff;
        cursor: pointer;
        min-width: 36px;
        transition: all 0.2s;
      }

      .pager button:hover:not(:disabled) {
        border-color: #3f51b5;
        color: #3f51b5;
      }

      .pager button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .pager button.active {
        background: #3f51b5;
        color: #fff;
        border-color: #3f51b5;
      }
    </style>
  </head>
  <body>
    <!-- 顶部导航栏 -->

    <header class="header">
      <div class="header-left">
        <button class="back-button" onclick="history.back()">&lt;</button>
        <h1>失物招领</h1>
      </div>

      <div class="dropdown-container">
        <div
          class="user-icon"
          th:style="'background-image: url(' + ${user.avatarUrl} + ');'"
        ></div>
        <div class="dropdown-menu">
          <button class="dropdown-item" onclick="location.href='/user/info'">
            个人信息
          </button>
          <button class="dropdown-item" onclick="logout()">退出登录</button>
        </div>
      </div>
    </header>

    <main class="page">
      <div class="page-title">失物招领列表</div>

      <section class="filters">
        <div class="filter-row">
          <span class="filter-label">地点：</span>
          <div class="chip-group" id="locationChips"></div>
          <button class="more-toggle" id="locationMore">更多 ▾</button>
        </div>
        <div class="filter-row">
          <span class="filter-label">物品：</span>
          <div class="chip-group" id="categoryChips"></div>
          <button class="more-toggle" id="categoryMore">更多 ▾</button>
        </div>
        <div class="filter-row">
          <span class="filter-label">状态：</span>
          <div class="chip-group">
            <button class="filter-chip active" data-status="" id="statusAll">
              全部
            </button>
            <button class="filter-chip" data-status="0" id="statusUnclaimed">
              未认领
            </button>
            <button class="filter-chip" data-status="1" id="statusClaimed">
              已认领
            </button>
          </div>
        </div>
        <div class="filter-row date-row">
          <span class="filter-label">时间：</span>
          <input type="date" id="beginTime" />
          <span>—</span>
          <input type="date" id="endTime" />
          <div style="flex: 1"></div>
          <button class="btn btn-ghost" id="resetBtn">重置</button>
          <button class="btn btn-primary" id="searchBtn">筛选</button>
        </div>
      </section>

      <section class="table-card">
        <table>
          <thead>
            <tr>
              <th style="width: 60px">序号</th>
              <th style="width: 160px">物品名称</th>
              <th style="width: 120px">分类</th>
              <th style="width: 120px">地点</th>
              <th>描述</th>
              <th style="width: 120px">图片</th>
              <th style="width: 120px">状态</th>
            </tr>
          </thead>
          <tbody id="lostTableBody">
            <tr>
              <td class="empty-row" colspan="7">加载中...</td>
            </tr>
          </tbody>
        </table>
        <div class="pagination">
          <div id="pagerInfo">第 1 页</div>
          <div class="pager" id="pager">
            <!-- 页码按钮将动态生成 -->
          </div>
        </div>
      </section>
    </main>

    <script>
      const state = {
        locationId: null,
        categoryId: null,
        status: null,
        beginTime: "",
        endTime: "",
        pageNum: 1,
        pageSize: 6,
        locationExpanded: false,
        categoryExpanded: false,
      };

      window.addEventListener("DOMContentLoaded", () => {
        fetchUserInfo();
        bindFilterActions();
        loadCategories();
        fetchLostList();
      });

      // 用户信息
      async function fetchUserInfo() {
        try {
          const response = await fetch("/user/user/my", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });

          const result = await response.json();
          if (result.code === "200" && result.data) {
            const user = result.data;
            if (user.avatarUrl) {
              const userIcon = document.querySelector(".user-icon");
              if (userIcon) {
                userIcon.style.backgroundImage = `url('${user.avatarUrl.trim()}')`;
              }
            }
          }
        } catch (error) {
          console.error("获取用户信息出错:", error);
        }
      }

      // 绑定筛选按钮
      function bindFilterActions() {
        document.getElementById("searchBtn").addEventListener("click", () => {
          state.beginTime = document.getElementById("beginTime").value;
          const endTimeValue = document.getElementById("endTime").value;
          // 如果选择了结束时间，则在该时间上加一天
          if (endTimeValue) {
            const endDate = new Date(endTimeValue);
            endDate.setDate(endDate.getDate() + 1);
            state.endTime = endDate.toISOString().split("T")[0];
          } else {
            state.endTime = "";
          }
          state.pageNum = 1;
          fetchLostList();
        });

        document.getElementById("resetBtn").addEventListener("click", () => {
          state.locationId = null;
          state.categoryId = null;
          state.status = null;
          state.beginTime = "";
          state.endTime = "";
          state.pageNum = 1;
          document.getElementById("beginTime").value = "";
          document.getElementById("endTime").value = "";
          markActiveChip("locationChips", null);
          markActiveChip("categoryChips", null);
          markActiveStatusChip("");
          fetchLostList();
        });

        document
          .getElementById("locationMore")
          .addEventListener("click", () => {
            state.locationExpanded = !state.locationExpanded;
            toggleMore("locationChips", state.locationExpanded, "locationMore");
          });

        document
          .getElementById("categoryMore")
          .addEventListener("click", () => {
            state.categoryExpanded = !state.categoryExpanded;
            toggleMore("categoryChips", state.categoryExpanded, "categoryMore");
          });

        // 状态筛选
        document.getElementById("statusAll").addEventListener("click", () => {
          state.status = null;
          state.pageNum = 1;
          markActiveStatusChip("");
          fetchLostList();
        });
        document
          .getElementById("statusUnclaimed")
          .addEventListener("click", () => {
            state.status = 0;
            state.pageNum = 1;
            markActiveStatusChip("0");
            fetchLostList();
          });
        document
          .getElementById("statusClaimed")
          .addEventListener("click", () => {
            state.status = 1;
            state.pageNum = 1;
            markActiveStatusChip("1");
            fetchLostList();
          });
      }

      function markActiveStatusChip(value) {
        const chips = document.querySelectorAll("[data-status]");
        chips.forEach((chip) => {
          chip.classList.toggle(
            "active",
            chip.dataset.status == value ||
              (!value && chip.dataset.status === "")
          );
        });
      }

      function toggleMore(containerId, expanded, buttonId) {
        const chips = document.querySelectorAll(
          `#${containerId} .filter-chip[data-extra="true"]`
        );
        chips.forEach((chip) => {
          chip.style.display = expanded ? "inline-flex" : "none";
        });

        // 更新按钮文字
        if (buttonId) {
          const button = document.getElementById(buttonId);
          if (button) {
            button.textContent = expanded ? "收起 ▴" : "更多 ▾";
          }
        }
      }

      // 加载分类
      async function loadCategories() {
        try {
          const [locationsRes, categoriesRes] = await Promise.all([
            fetch("/user/lostAndFound/getAllLocationCategory", {
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
            }),
            fetch("/user/lostAndFound/getAllItemCategory", {
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
            }),
          ]);

          const locations = await locationsRes.json();
          const categories = await categoriesRes.json();

          renderChips(
            locations.code === "200" ? locations.data || [] : [],
            "locationChips",
            "locationId"
          );
          renderChips(
            categories.code === "200" ? categories.data || [] : [],
            "categoryChips",
            "categoryId"
          );
        } catch (error) {
          console.error("加载分类失败", error);
        }
      }

      function renderChips(list, containerId, key) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";

        const allChip = document.createElement("button");
        allChip.className = "filter-chip";
        allChip.textContent = "全部";
        allChip.dataset.value = "";
        allChip.addEventListener("click", () => {
          state[key] = null;
          state.pageNum = 1;
          markActiveChip(containerId, null);
          fetchLostList();
        });
        container.appendChild(allChip);

        list.forEach((item, idx) => {
          const chip = document.createElement("button");
          chip.className = "filter-chip";
          chip.textContent = item.categoryName || item.locationName || "未命名";
          const value = item.categoryId || item.locationId;
          chip.dataset.value = value;
          if (idx >= 10) {
            chip.dataset.extra = "true";
            chip.style.display = "none";
          }
          chip.addEventListener("click", () => {
            state[key] = value;
            state.pageNum = 1;
            markActiveChip(containerId, value);
            fetchLostList();
          });
          container.appendChild(chip);
        });

        // 只有当分类数量大于10时才显示"更多"按钮
        const moreButton =
          containerId === "locationChips"
            ? document.getElementById("locationMore")
            : document.getElementById("categoryMore");
        if (moreButton) {
          moreButton.style.display = list.length > 10 ? "inline-block" : "none";
        }

        markActiveChip(containerId, state[key]);
      }

      function markActiveChip(containerId, value) {
        const chips = document.querySelectorAll(`#${containerId} .filter-chip`);
        chips.forEach((chip) => {
          chip.classList.toggle(
            "active",
            chip.dataset.value == value || (!value && chip.dataset.value === "")
          );
        });
      }

      // 列表
      async function fetchLostList() {
        const body = document.getElementById("lostTableBody");
        body.innerHTML = `<tr><td class="empty-row" colspan="7">加载中...</td></tr>`;

        const params = new URLSearchParams({
          pageNum: state.pageNum,
          pageSize: state.pageSize,
          locationId: state.locationId || "",
          categoryId: state.categoryId || "",
          status: state.status !== null ? state.status : "",
          beginTime: state.beginTime || "",
          endTime: state.endTime || "",
        });

        try {
          const res = await fetch(
            `/user/lostAndFound/getLostAndFoundList?${params.toString()}`,
            {
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
            }
          );
          const result = await res.json();
          console.log(result);
          if (result.code === "200" && result.data) {
            renderTable(result.data.records || [], result.data.total || 0);
          } else {
            renderTable([], 0);
          }
        } catch (error) {
          console.error("获取列表失败", error);
          renderTable([], 0);
        }
      }

      function renderTable(list, total) {
        const body = document.getElementById("lostTableBody");
        body.innerHTML = "";

        if (!list || list.length === 0) {
          body.innerHTML = `<tr><td class="empty-row" colspan="7">暂无数据</td></tr>`;
          updatePager(total);
          return;
        }

        list.forEach((item, idx) => {
          const tr = document.createElement("tr");
          const index = (state.pageNum - 1) * state.pageSize + idx + 1;
          const imageCell = item.imageUrls
            ? `<img class="item-img" src="${item.imageUrls}" alt="item" onerror="this.style.display='none';this.parentElement.textContent='-';" />`
            : "-";
          tr.innerHTML = `
            <td>${index}</td>
            <td>${item.itemName || "-"}</td>
            <td>${item.categoryName || "-"}</td>
            <td>${item.locationName || "-"}</td>
            <td>${item.description || "-"}</td>
            <td>${imageCell}</td>
            <td>${statusTag(item.status)}</td>
          `;
          body.appendChild(tr);
        });

        updatePager(total);
      }

      function statusTag(status) {
        if (status === 1 || status === "1") {
          return '<span class="status-tag status-done">已认领</span>';
        }
        return '<span class="status-tag status-pending">未认领</span>';
      }

      function updatePager(total) {
        const totalPages = Math.max(1, Math.ceil(total / state.pageSize));
        document.getElementById("pagerInfo").textContent = `共 ${total} 条`;

        const pager = document.getElementById("pager");
        pager.innerHTML = "";

        // 上一页按钮
        const prevBtn = document.createElement("button");
        prevBtn.textContent = "上一页";
        prevBtn.disabled = state.pageNum <= 1;
        prevBtn.addEventListener("click", () => {
          if (state.pageNum > 1) {
            state.pageNum -= 1;
            fetchLostList();
          }
        });
        pager.appendChild(prevBtn);

        // 生成页码按钮
        const pageNumbers = getPageNumbers(state.pageNum, totalPages);
        pageNumbers.forEach((page) => {
          if (page === "...") {
            const ellipsis = document.createElement("span");
            ellipsis.textContent = "...";
            ellipsis.style.padding = "6px 10px";
            pager.appendChild(ellipsis);
          } else {
            const pageBtn = document.createElement("button");
            pageBtn.textContent = page;
            pageBtn.className = page === state.pageNum ? "active" : "";
            pageBtn.addEventListener("click", () => {
              state.pageNum = page;
              fetchLostList();
            });
            pager.appendChild(pageBtn);
          }
        });

        // 下一页按钮
        const nextBtn = document.createElement("button");
        nextBtn.textContent = "下一页";
        nextBtn.disabled = state.pageNum >= totalPages;
        nextBtn.addEventListener("click", () => {
          if (state.pageNum < totalPages) {
            state.pageNum += 1;
            fetchLostList();
          }
        });
        pager.appendChild(nextBtn);
      }

      function getPageNumbers(currentPage, totalPages) {
        const pages = [];

        if (totalPages <= 7) {
          // 总页数不超过7页，显示所有页码
          for (let i = 1; i <= totalPages; i++) {
            pages.push(i);
          }
        } else {
          // 总页数超过7页，显示部分页码
          if (currentPage <= 4) {
            // 当前页靠前
            for (let i = 1; i <= 5; i++) {
              pages.push(i);
            }
            pages.push("...");
            pages.push(totalPages);
          } else if (currentPage >= totalPages - 3) {
            // 当前页靠后
            pages.push(1);
            pages.push("...");
            for (let i = totalPages - 4; i <= totalPages; i++) {
              pages.push(i);
            }
          } else {
            // 当前页在中间
            pages.push(1);
            pages.push("...");
            for (let i = currentPage - 1; i <= currentPage + 1; i++) {
              pages.push(i);
            }
            pages.push("...");
            pages.push(totalPages);
          }
        }

        return pages;
      }

      // 退出登录
      function logout() {
        if (confirm("确定要退出登录吗？")) {
          localStorage.removeItem("token");
          window.location.href = "/users/login";
        }
      }
    </script>
  </body>
</html>
