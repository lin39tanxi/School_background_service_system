<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>调换宿舍 - 校园后勤管理系统</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Microsoft YaHei", Arial, sans-serif;
        background-image: url(http://localhost:8081/img/35e1b763c15645c1a6d674accf959f30.jpg);
        min-height: 100vh;
        background-size: cover;
        background-attachment: fixed;
      }

      .header {
        background: #3f51b5;
        color: #fff;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .back-button {
        background: none;
        border: none;
        color: #fff;
        font-size: 28px;
        cursor: pointer;
        padding: 5px 15px;
        transition: opacity 0.3s;
      }

      .back-button:hover {
        opacity: 0.8;
      }

      .header-left {
        display: flex;
        align-items: center;
      }

      .header h1 {
        padding-left: 20px;
        font-size: 24px;
        font-weight: normal;
      }

      .user-icon {
        width: 45px;
        height: 45px;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid rgba(255, 255, 255, 0.5);
        overflow: hidden;
      }

      .user-icon:hover {
        transform: scale(1.05);
        border-color: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      }

      .dropdown-container {
        position: relative;
        display: inline-block;
      }

      .dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 10px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        z-index: 1000;
        width: 150px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
      }

      .dropdown-container:hover .dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-item {
        width: 100%;
        padding: 12px 20px;
        background: none;
        border: none;
        text-align: left;
        cursor: pointer;
        color: #333;
        font-size: 14px;
        transition: all 0.2s;
        outline: none;
      }

      .dropdown-item:hover {
        background: #f5f5f5;
        color: #3f51b5;
      }

      .dropdown-item:not(:last-child) {
        border-bottom: 1px solid #eee;
      }

      .page {
        max-width: 960px;
        margin: 26px auto 40px;
        padding: 0 18px;
      }

      .card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 26px;
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.12);
        backdrop-filter: blur(4px);
      }

      .card h2 {
        font-size: 22px;
        color: #333;
        margin-bottom: 16px;
      }

      .grid-3 {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 14px;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 14px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 14px;
      }

      label {
        color: #555;
        font-size: 14px;
        font-weight: 600;
      }

      .required {
        color: #f44336;
        margin-left: 4px;
      }

      input,
      select,
      textarea {
        padding: 10px 12px;
        border: 1px solid #d6d9e0;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        background: #fff;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #3f51b5;
        box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.12);
      }

      input[readonly] {
        background: #f6f7fb;
        cursor: not-allowed;
      }

      textarea {
        min-height: 140px;
        resize: vertical;
      }

      .actions {
        margin-top: 18px;
        text-align: center;
      }

      .submit-btn {
        min-width: 180px;
        padding: 13px 18px;
        border: none;
        border-radius: 8px;
        background: #3f51b5;
        color: #fff;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .submit-btn:hover {
        background: #3244a3;
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(63, 81, 181, 0.25);
      }

      .submit-btn:disabled {
        background: #9fa8da;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .status-text {
        margin-top: 8px;
        text-align: center;
        color: #f44336;
        font-size: 14px;
        min-height: 18px;
      }

      @media (max-width: 768px) {
        .grid-3,
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-left">
        <button class="back-button" onclick="goBack()">&lt;</button>
        <h1>调换宿舍</h1>
      </div>

      <div class="dropdown-container">
        <div
          class="user-icon"
          th:style="'background-image: url(' + ${user.avatarUrl} + ');'"
        ></div>
        <div class="dropdown-menu">
          <button class="dropdown-item" onclick="location.href='/user/info'">
            个人信息
          </button>
          <button class="dropdown-item" onclick="logout()">退出登录</button>
        </div>
      </div>
    </header>

    <main class="page">
      <section class="card">
        <h2>宿舍调换申请</h2>
        <form id="changeDormForm">
          <div class="grid-2">
            <div class="form-group">
              <label>姓名</label>
              <input id="userName" type="text" readonly />
            </div>
            <div class="form-group">
              <label>学号</label>
              <input id="studentNumber" type="text" readonly />
            </div>
          </div>

          <div class="form-group">
            <label>原宿舍</label>
            <input id="oldDorm" type="text" readonly />
          </div>

          <div class="grid-3">
            <div class="form-group">
              <label>目标宿舍 - 楼栋 <span class="required">*</span></label>
              <select id="buildingSelect" required>
                <option value="">请选择楼栋</option>
              </select>
            </div>
            <div class="form-group">
              <label>目标宿舍 - 楼层 <span class="required">*</span></label>
              <select id="floorSelect" required disabled>
                <option value="">请选择楼层</option>
              </select>
            </div>
            <div class="form-group">
              <label>目标宿舍 - 房间 <span class="required">*</span></label>
              <select id="roomSelect" required disabled>
                <option value="">请选择房间</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>调换理由 <span class="required">*</span></label>
            <textarea
              id="reason"
              placeholder="请填写调换原因"
              required
            ></textarea>
          </div>

          <div class="actions">
            <button type="submit" class="submit-btn" id="submitBtn">
              提交
            </button>
            <div class="status-text" id="statusText"></div>
          </div>
        </form>
      </section>
    </main>

    <script>
      let userInfo = null;

      window.addEventListener("DOMContentLoaded", () => {
        fetchUserInfo();
        bindSelectors();
        bindSubmit();
      });

      async function fetchUserInfo() {
        try {
          const response = await fetch("/user/user/my", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });

          const result = await response.json();
          if ((result.code === "200" || result.code === 200) && result.data) {
            userInfo = result.data;
            fillUserFields(result.data);
            loadBuildings();
          } else {
            setStatus(result.message || "获取用户信息失败");
          }
        } catch (error) {
          console.error("获取用户信息出错:", error);
          setStatus("获取用户信息失败");
        }
      }

      function fillUserFields(data) {
        document.getElementById("userName").value = data.name || "";
        document.getElementById("studentNumber").value =
          data.studentNumber || "";
        const oldDorm = `${data.building || ""}${data.dormitory || ""}宿舍`;
        document.getElementById("oldDorm").value = oldDorm.trim();

        if (data.avatarUrl) {
          const userIcon = document.querySelector(".user-icon");
          if (userIcon)
            userIcon.style.backgroundImage = `url('${data.avatarUrl.trim()}')`;
        }
      }

      function bindSelectors() {
        document
          .getElementById("buildingSelect")
          .addEventListener("change", onBuildingChange);
        document
          .getElementById("floorSelect")
          .addEventListener("change", onFloorChange);
      }

      async function loadBuildings() {
        try {
          const token = localStorage.getItem("token") || "";
          const resp = await fetch("/user/dormitory/getAllBuildingVO", {
            headers: { Authorization: token ? "Bearer " + token : "" },
          });
          const result = await resp.json();
          console.log("楼栋数据", result);
          if ((result.code === "200" || result.code === 200) && Array.isArray(result.data)) {
            populateSelect(
              "buildingSelect",
              result.data,
              "buildingId",
              "buildingName"
            );
          }
        } catch (e) {
          console.error("加载楼栋失败", e);
        }
      }

      async function onBuildingChange(e) {
        const buildingId = e.target.value;
        resetSelect("floorSelect", "请选择楼层", true);
        resetSelect("roomSelect", "请选择房间", true);
        if (!buildingId) return;
        try {
          const token = localStorage.getItem("token") || "";
          const resp = await fetch(
            `/user/dormitory/getFloorsByBuilding?buildingId=${buildingId}`,
            {
              headers: { Authorization: token ? "Bearer " + token : "" },
            }
          );
          const result = await resp.json();
          console.log("楼层数据", result);
          if ((result.code === "200" || result.code === 200) && Array.isArray(result.data)) {
            populateSelect("floorSelect", result.data, "floorId", "floorName");
            document.getElementById("floorSelect").disabled = false;
          } else {
            document.getElementById("floorSelect").disabled = false;
          }
        } catch (err) {
          console.error("加载楼层失败", err);
        }
      }

      async function onFloorChange(e) {
        const floorId = e.target.value;
        const buildingId = document.getElementById("buildingSelect").value;
        resetSelect("roomSelect", "请选择房间", true);
        if (!floorId || !buildingId) return;
        try {
          const token = localStorage.getItem("token") || "";
          const resp = await fetch(
            `/user/dormitory/getAllBuildingAndFloorAndRooms?buildingId=${buildingId}&floorId=${floorId}`,
            { headers: { Authorization: token ? "Bearer " + token : "" } }
          );
          const result = await resp.json();
          console.log("房间数据", result);
          if ((result.code === "200" || result.code === 200) && Array.isArray(result.data)) {
            populateSelect("roomSelect", result.data, "roomId", "roomNumber");
            document.getElementById("roomSelect").disabled = false;
          } else {
            document.getElementById("roomSelect").disabled = false;
          }
        } catch (err) {
          console.error("加载房间失败", err);
        }
        
      }
      
      function populateSelect(selectId, list, valueKey, labelKey) {
        const sel = document.getElementById(selectId);
        sel.innerHTML = `<option value="">请选择</option>`;
        list.forEach((item) => {
          const opt = document.createElement("option");
          opt.value = item[valueKey];
          opt.textContent = item[labelKey];
          opt.dataset.label = item[labelKey];
          sel.appendChild(opt);
        });
      }

      function resetSelect(id, placeholder, disable) {
        const sel = document.getElementById(id);
        sel.innerHTML = `<option value="">${placeholder}</option>`;
        sel.disabled = !!disable;
      }

      function bindSubmit() {
        const form = document.getElementById("changeDormForm");
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!validate()) return;

          const submitBtn = document.getElementById("submitBtn");
          submitBtn.disabled = true;
          setStatus("提交中...");

          const buildingSel = document.getElementById("buildingSelect");
          const floorSel = document.getElementById("floorSelect");
          const roomSel = document.getElementById("roomSelect");

          const buildingName =
            buildingSel.options[buildingSel.selectedIndex].dataset.label || "";
          const roomLabel =
            roomSel.options[roomSel.selectedIndex].dataset.label ||
            roomSel.options[roomSel.selectedIndex].textContent;

          const payload = {
            studentNumber: userInfo?.studentNumber || "",
            oldDormAddress: document.getElementById("oldDorm").value,
            newDormAddress: `${buildingName}${roomLabel}宿舍`,
            buildingId: Number(buildingSel.value),
            floorId: Number(floorSel.value),
            roomId: Number(roomSel.value),
            reason: document.getElementById("reason").value.trim(),
          };

          try {
            const token = localStorage.getItem("token") || "";
            const resp = await fetch("/user/dormitory/changeDormitory", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: token ? "Bearer " + token : "",
              },
              body: JSON.stringify(payload),
            });

            const result = await resp.json();
            if (result.code === "200" || resp.ok) {
              setStatus("提交成功", true);
              form.reset();
              resetSelect("floorSelect", "请选择楼层", true);
              resetSelect("roomSelect", "请选择房间", true);
            } else {
              setStatus(result.message || "提交失败");
            }
          } catch (err) {
            console.error("提交失败", err);
            setStatus("网络错误，请稍后重试");
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "提交";
          }
        });
      }

      function validate() {
        const building = document.getElementById("buildingSelect").value;
        const floor = document.getElementById("floorSelect").value;
        const room = document.getElementById("roomSelect").value;
        const reason = document.getElementById("reason").value.trim();
        if (!building || !floor || !room) {
          setStatus("请选择完整的目标宿舍");
          return false;
        }
        if (!reason) {
          setStatus("请填写调换理由");
          return false;
        }
        setStatus("");
        return true;
      }

      function setStatus(msg, success = false) {
        const el = document.getElementById("statusText");
        el.style.color = success ? "#4caf50" : "#f44336";
        el.textContent = msg || "";
      }

      function goBack() {
        if (history.length > 1) {
          history.back();
        } else {
          location.href = "/user/info";
        }
      }

      function logout() {
        if (confirm("确定要退出登录吗？")) {
          localStorage.removeItem("token");
          window.location.href = "/users/login";
        }
      }
    </script>
  </body>
</html>
